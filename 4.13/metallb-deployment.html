<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Metallb deployment :: LAB - Telco HyperShift on Baremetal</title>
    <link rel="canonical" href="https://labs.sysdeseng.com/4.13/metallb-deployment.html">
    <link rel="prev" href="cluster-deployment.html">
    <link rel="next" href="#cluster-review.adoc">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/solutions/telecommunications" target="_blank"><img src="../_/img/Logo-Red_Hat-A-Reverse-RGB.png" height="40px" alt="Red Hat Telco Solutions"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://labs.sysdeseng.com">LAB - Telco HyperShift on Baremetal</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="4.13" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Welcome</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#contributors">Contributors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="introduction.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#lab-aim">Who is this lab aimed at?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#lab-software-versions">Lab Software Versions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="acronyms.html">Acronyms used in the lab</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="about-hypershift.html">About HyperShift</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="general-prerequisites.html">General Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="hypershift-installation.html">HyperShift Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hypershift-installation.html#install-mce-operator">Install MCE operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hypershift-installation.html#configure-baremetal-operator">Configure Bare Metal Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hypershift-installation.html#configure-assisted-service">Configure Assisted Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="infraenv-deployment.html">Infraenv Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="infraenv-deployment.html#create-infraenv">Create Infraenv</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="cluster-deployment.html">Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#create-hosted-cluster">Create Hosted Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#create-nodepool">Create Node Pool</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#create-bmhs">Create Baremetal Hosts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#check-control-plane">Check Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#check-assisted-components">Check Assisted Components</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="metallb-deployment.html">Metallb deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#install-metallb-operator">Install Metal LB operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#configure-metallb-operator">Configure Metal LB operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#configure-ingress-service">Configure Ingress service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cluster-review.adoc">Accessing cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cluster-review.adoc#gathering-kubeconfig">Gathering Kubeconfig</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cluster-review.adoc#check-installation">Check Installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab-review.html">Review</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="additional-resources.html">Additional Resources</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="additional-resources.html#documentation">Documentation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lab-setup.html">Lab Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#lab-requirements">Lab Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#install-kcli">Install kcli</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#create-baremetal-like-vms">Create Baremetal like VMs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#create-dns-entries">Create DNS Entries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#install-base-cluster">Install Base cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#set-haproxy">Set haproxy</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">LAB - Telco HyperShift on Baremetal</a></li>
    <li><a href="metallb-deployment.html">Metallb deployment</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/RHsyseng/telco-hypershift-baremetal-lab/edit/lab-4.13/documentation/modules/ROOT/pages/metallb-deployment.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Metallb deployment</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this section, we install Metallb operator and configure it so that our installation gets fully functional, through a loadbalancer ip  that will target our ingress service</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-metallb-operator"><a class="anchor" href="#install-metallb-operator"></a>Install Metal LB operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We inject the following yaml to deploy the operator</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: metallb-operator
  namespace: openshift-operators
spec:
  channel: "stable"
  name: metallb-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f scripts/METALLB/install.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expected Output</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">subscription.operators.coreos.com/metallb-operator created</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the following loop to wait for the proper CRD to be available</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">timeout=0
ready=false
while [ "$timeout" -lt "240" ] ; do
  oc get crd | grep -q metallb &amp;&amp; ready=true &amp;&amp; break;
  echo "Waiting for CRD MetalLB to be created"
  sleep 5
  timeout=$$timeout + 5
done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expectd Output</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Waiting for CRD MetalLB to be created
Waiting for CRD MetalLB to be created
Waiting for CRD MetalLB to be created
Waiting for CRD MetalLB to be created
(...)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-metallb-operator"><a class="anchor" href="#configure-metallb-operator"></a>Configure Metal LB operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We then define the following CR to deploy a metallb instance and create the proper configuration for our vip</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apiVersion: metallb.io/v1beta1
kind: MetalLB
metadata:
  name: metallb
  namespace: openshift-operators
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: hypershift-vip
  namespace: openshift-operators
spec:
  protocol: layer2
  autoAssign: false
  addresses:
    - ${VIP}-${VIP}
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: hypershift-vip
  namespace: openshift-operators
spec:
  ipAddressPools:
  - hypershift-vip</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export VIP=192.168.122.252
envsubst &lt; scripts/METALLB/metallb_cr.yaml.sample | oc create -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expected Output</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">metallb.metallb.io/metallb created
ipaddresspool.metallb.io/hypershift-vip created
l2advertisement.metallb.io/default created</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-ingress-service"><a class="anchor" href="#configure-ingress-service"></a>Configure Ingress service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With this available load balancer ip, we will patch the ingress service on our deployed cluster so that it makes use of it</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kind: Service
apiVersion: v1
metadata:
  annotations:
    metallb.universe.tf/address-pool: hypershift-vip
  name: metallb-ingress
  namespace: openshift-ingress
spec:
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 80
    - name: https
      protocol: TCP
      port: 443
      targetPort: 443
  selector:
    ingresscontroller.operator.openshift.io/deployment-ingresscontroller: default
  type: LoadBalancer</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f scripts/METALLB/service.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expected Output</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">service/metallb-ingress created</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, the cluster should be fully available!</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="cluster-deployment.html">Cluster Deployment</a></span>
  <span class="next"><a href="#cluster-review.adoc">Accessing cluster</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
