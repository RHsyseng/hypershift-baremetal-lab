<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Infraenv Deployment :: LAB - Telco HyperShift on Baremetal</title>
    <link rel="canonical" href="https://labs.sysdeseng.com/4.13/infraenv-deployment.html">
    <link rel="prev" href="hypershift-installation.html">
    <link rel="next" href="cluster-deployment.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/solutions/telecommunications" target="_blank"><img src="../_/img/Logo-Red_Hat-A-Reverse-RGB.png" height="40px" alt="Red Hat Telco Solutions"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://labs.sysdeseng.com">LAB - Telco HyperShift on Baremetal</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="4.13" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Welcome</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#contributors">Contributors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="introduction.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#lab-aim">Who is this lab aimed at?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#lab-software-versions">Lab Software Versions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="acronyms.html">Acronyms used in the lab</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="about-hypershift.html">About HyperShift</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="general-prerequisites.html">General Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="hypershift-installation.html">HyperShift Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hypershift-installation.html#install-mce-operator">Install MCE operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hypershift-installation.html#configure-baremetal-operator">Configure Bare Metal Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hypershift-installation.html#configure-assisted-service">Configure Assisted Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="infraenv-deployment.html">Infraenv Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#create-infraenv">Create Infraenv</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="cluster-deployment.html">Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#create-hosted-cluster">Create Hosted Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#create-nodepool">Create Node Pool</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#create-bmhs">Create Baremetal Hosts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#check-control-plane">Check Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-deployment.html#check-assisted-components">Check Assisted Components</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="metallb-deployment.html">Metallb deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="metallb-deployment.html#install-metallb-operator">Install Metal LB operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="metallb-deployment.html#configure-metallb-operator">Configure Metal LB operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="metallb-deployment.html#configure-ingress-service">Configure Ingress service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="accessing-cluster.html">Accessing cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="metallb-deployment.html#accessing-cluster">Accessing the cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="review.html">Review</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="additional-resources.html">Additional Resources</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="additional-resources.html#documentation">Documentation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lab-setup.html">Lab Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#lab-requirements">Lab Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#install-kcli">Install kcli</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#create-baremetal-like-vms">Create Baremetal like vms</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#install-base-cluster">Install Base cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-setup.html#set-haproxy">Set haproxy</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">LAB - Telco HyperShift on Baremetal</a></li>
    <li><a href="infraenv-deployment.html">Infraenv Deployment</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/RHsyseng/telco-hypershift-baremetal-lab/edit/lab-4.13/documentation/modules/ROOT/pages/infraenv-deployment.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Infraenv Deployment</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this section, we prepare an Infraenv environment as a requisite to leverage the agent provider.</p>
</div>
<div class="paragraph">
<p>This infrastructure will allow to generate an iso we&#8217;ll plug later to the nodes to boot them and drive their installation.</p>
</div>
<div class="paragraph">
<p>In the following yaml, we will replace the variables PULL_SECRET and SSH_PUB_KEY with the corresponding values</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-infraenv"><a class="anchor" href="#create-infraenv"></a>Create Infraenv</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will render a yaml such as the following one:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apiVersion: v1
kind: Namespace
metadata:
  name: clusters-${CLUSTER}
---
apiVersion: v1
data:
 .dockerconfigjson: ${PULL_SECRET}
kind: Secret
metadata:
  name: ${CLUSTER}-pull-secret
  namespace: clusters-${CLUSTER}
type: kubernetes.io/dockerconfigjson
---
apiVersion: v1
kind: Secret
metadata:
  name: ${CLUSTER}-ssh-key
  namespace: clusters-${CLUSTER}
stringData:
  id_rsa.pub: ${SSH_PUB_KEY}
---
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  creationTimestamp: null
  name: capi-provider-role
  namespace: clusters-${CLUSTER}
rules:
- apiGroups:
  - agent-install.openshift.io
  resources:
  - agents
  verbs:
  - '*'
---
apiVersion: agent-install.openshift.io/v1beta1
kind: InfraEnv
metadata:
  name: ${CLUSTER}
  namespace: clusters-${CLUSTER}
spec:
  pullSecretRef:
    name: ${CLUSTER}-pull-secret
  sshAuthorizedKey: ${SSH_PUB_KEY}
  agentLabels:
    cluster-name: clusters-${CLUSTER}
  nmStateConfigLabelSelector:
    matchLabels:
      cluster-name: clusters-${CLUSTER}</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export CLUSTER=myhypershift
export PULL_SECRET=$(cat ~/openshift_pull.json | tr -d [:space:]| base64 -w0)
export SSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)
envsubst &lt; scripts/INFRAENV/infraenv.yaml.sample | oc create -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expected Output</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">namespace/clusters-myhypershift created
secret/myhypershift-pull-secret created
secret/myhypershift-ssh-key created
role.rbac.authorization.k8s.io/capi-provider-role created
infraenv.agent-install.openshift.io/myhypershift created</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a moment, we can check the resulting object, and in particular see that in <code>status/isoDownloadURL</code> an url for downloading an ISO got generated. This is the iso that can be plugged to the bare metal nodes.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export CLUSTER=myhypershift
oc get infraenv -n clusters-$CLUSTER $CLUSTER -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">apiVersion: agent-install.openshift.io/v1beta1
kind: InfraEnv
metadata:
  creationTimestamp: "2023-05-18T15:47:06Z"
  finalizers:
  - infraenv.agent-install.openshift.io/ai-deprovision
  generation: 1
  name: myhypershift
  namespace: clusters-myhypershift
  resourceVersion: "143719"
  uid: 75ddf90e-1eb7-41d4-a840-a782649d10df
spec:
  agentLabels:
    cluster-name: clusters-myhypershift
  cpuArchitecture: x86_64
  ipxeScriptType: DiscoveryImageAlways
  nmStateConfigLabelSelector:
    matchLabels:
      cluster-name: clusters-myhypershift
  pullSecretRef:
    name: myhypershift-pull-secret
status:
  agentLabelSelector:
    matchLabels:
      infraenvs.agent-install.openshift.io: myhypershift
  bootArtifacts:
    initrd: https://assisted-image-service-multicluster-engine.apps.basecluster.192-168-122-253.sslip.io/images/c2ab7692-6445-4605-b3ff-be8f73258517/pxe-initrd?api_key=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpbmZyYV9lbnZfaWQiOiJjMmFiNzY5Mi02NDQ1LTQ2MDUtYjNmZi1iZThmNzMyNTg1MTcifQ.EF6eAHuteadbMruTZlu9q-LphVzvF_O6BQQMvIgIf1IY_1LoHEZMq7LxdzlLAHSfkfSNRM4yT45qWcjCxiIlHw&amp;arch=x86_64&amp;version=4.13
    ipxeScript: https://assisted-service-multicluster-engine.apps.basecluster.192-168-122-253.sslip.io/api/assisted-install/v2/infra-envs/c2ab7692-6445-4605-b3ff-be8f73258517/downloads/files?api_key=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpbmZyYV9lbnZfaWQiOiJjMmFiNzY5Mi02NDQ1LTQ2MDUtYjNmZi1iZThmNzMyNTg1MTcifQ.ccrICUopYN3ro5fFNMQfiHG1CCtyJh-cORGeg6qrTif92nZDZT2cJdFsGQJRim6Llw7OPogBCTEKxjZeURWPTQ&amp;file_name=ipxe-script
    kernel: https://assisted-image-service-multicluster-engine.apps.basecluster.192-168-122-253.sslip.io/boot-artifacts/kernel?arch=x86_64&amp;version=4.13
    rootfs: https://assisted-image-service-multicluster-engine.apps.basecluster.192-168-122-253.sslip.io/boot-artifacts/rootfs?arch=x86_64&amp;version=4.13
  conditions:
  - lastTransitionTime: "2023-05-18T15:47:06Z"
    message: Image has been created
    reason: ImageCreated
    status: "True"
    type: ImageCreated
  createdTime: "2023-05-18T15:47:06Z"
  debugInfo:
    eventsURL: https://assisted-service-multicluster-engine.apps.basecluster.192-168-122-253.sslip.io/api/assisted-install/v2/events?api_key=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpbmZyYV9lbnZfaWQiOiJjMmFiNzY5Mi02NDQ1LTQ2MDUtYjNmZi1iZThmNzMyNTg1MTcifQ.ZenDXcOz2P0HwFmS2If-QGMWwg3qTM9o2F4lyJY2DMR0XiB_yKZYFjKj9VSDSKzBNxjIMec3le67EQFfUWTHBA&amp;infra_env_id=c2ab7692-6445-4605-b3ff-be8f73258517
  isoDownloadURL: https://assisted-image-service-multicluster-engine.apps.basecluster.192-168-122-253.sslip.io/images/c2ab7692-6445-4605-b3ff-be8f73258517?api_key=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpbmZyYV9lbnZfaWQiOiJjMmFiNzY5Mi02NDQ1LTQ2MDUtYjNmZi1iZThmNzMyNTg1MTcifQ.UOr7d-AhCrXlzSUxBeBdB2zOuTHDGr_VC4oIOc2uizc3JTSjxuqeUK75qqao1u0OPT_Ayg5ohTydcM6pP47IUA&amp;arch=x86_64&amp;type=minimal-iso&amp;version=4.13</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="hypershift-installation.html">HyperShift Installation</a></span>
  <span class="next"><a href="cluster-deployment.html">Cluster Deployment</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
